name: ImmortalWRT X86 Config Builder

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆè¿›å…¥Codespacesäº¤äº’è°ƒè¯•ï¼‰'
        required: false
        default: false
  push:
    branches: [main, master]
    paths: ['**.config', '**.sh']

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  CONFIG_FILE: X86_imm.config
  DIY_SH: diy-imm.sh
  FILE_NAME: X86
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: source

    - name: Setup dual workspace
      run: |
        # è®¾ç½®æ ‡å‡†å·¥ä½œç›®å½•
        mkdir -p /workspaces/$GITHUB_REPOSITORY/openwrt
        sudo mkdir -p /mnt/workdir
        sudo chown -R $USER:$USER /mnt/workdir
        ln -sf /workspaces/$GITHUB_REPOSITORY/openwrt /mnt/workdir/openwrt
        echo "WORKDIR=/mnt/workdir" >> $GITHUB_ENV

    - name: Install build dependencies
      run: |
        sudo apt update && sudo apt install -y \
          build-essential \
          libncurses5-dev \
          libssl-dev \
          git \
          make \
          unison

    - name: Clone source code
      working-directory: /mnt/workdir
      run: |
        git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt || \
        { echo "::error::å…‹éš†æºç å¤±è´¥"; exit 1; }
        cd openwrt
        echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date '+%Y%m%d-%H%M%S')" >> $GITHUB_ENV

    - name: Apply configuration
      working-directory: /mnt/workdir/openwrt
      run: |
        cp "$GITHUB_WORKSPACE/source/$CONFIG_FILE" .config
        [ -f "$GITHUB_WORKSPACE/source/$DIY_SH" ] && {
          chmod +x "$GITHUB_WORKSPACE/source/$DIY_SH"
          "$GITHUB_WORKSPACE/source/$DIY_SH"
        }

    - name: Start debug session
      if: ${{ inputs.debug_enabled }}
      run: |
        echo "ğŸ”§ è°ƒè¯•æ¨¡å¼å·²æ¿€æ´»" | tee debug_instructions.txt
        echo "1. è®¿é—® https://github.com/codespaces/new?repo=$GITHUB_REPOSITORY" >> debug_instructions.txt
        echo "2. å¯åŠ¨åè¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿æŒåŒæ­¥ï¼š" >> debug_instructions.txt
        echo "   while true; do unison -auto -batch /workspaces/$GITHUB_REPOSITORY/openwrt /mnt/workdir/openwrt; sleep 5; done" >> debug_instructions.txt
        echo "3. ç»ˆæ­¢è°ƒè¯•è¯·æ‰§è¡Œï¼š" >> debug_instructions.txt
        echo "   curl -X POST -H \"Authorization: token ${{ secrets.GITHUB_TOKEN }}\" \\" >> debug_instructions.txt
        echo "     https://api.github.com/repos/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID/cancel" >> debug_instructions.txt
        
        # ä¸Šä¼ è°ƒè¯•è¯´æ˜
        echo "::warning::è°ƒè¯•æŒ‡å—å·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹ArtifactsåŒºåŸŸçš„debug-guide"
        actions/upload-artifact@v3 --name debug-guide --path debug_instructions.txt
        
        # ä¿æŒè¿è¡Œï¼ˆæ¯10åˆ†é’Ÿæ£€æµ‹æ˜¯å¦ç»§ç»­ï¼‰
        while sleep 600; do
          [ -f "/mnt/workdir/DEBUG_CONTINUE" ] && break
        done

    - name: Generate config package
      run: |
        OUTPUT_NAME="${FILE_NAME}-${COMMIT_HASH}-${BUILD_DATE}.config"
        cp "/mnt/workdir/openwrt/.config" "$OUTPUT_NAME"
        
        # è°ƒè¯•æ¨¡å¼ä¸‹è¾“å‡ºç‰¹æ®Šæç¤º
        if ${{ inputs.debug_enabled }}; then
          echo "::notice::ğŸ“ è°ƒè¯•æ¨¡å¼é…ç½®æ–‡ä»¶è·¯å¾„ï¼š"
          echo "/mnt/workdir/openwrt/.config"
          echo "æˆ–é€šè¿‡Artifactsä¸‹è½½ï¼š$OUTPUT_NAME"
        fi
        
        echo "CONFIG_PATH=$PWD/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: Upload config artifact
      uses: actions/upload-artifact@v3
      with:
        name: openwrt-config
        path: ${{ env.CONFIG_PATH }}
        retention-days: 7

    - name: Create release
      if: ${{ !inputs.debug_enabled }}
      uses: softprops/action-gh-release@v1
      with:
        name: "ImmortalWRT ${{ env.FILE_NAME }} Config"
        tag_name: "config-${{ env.BUILD_DATE }}"
        body: |
          è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ï¼š
          - ç‰ˆæœ¬: ${{ env.COMMIT_HASH }}
          - æ—¶é—´: ${{ env.BUILD_DATE }}
        files: ${{ env.CONFIG_PATH }}
        token: ${{ secrets.GITHUB_TOKEN }}
