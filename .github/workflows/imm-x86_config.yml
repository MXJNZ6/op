name: imm_x86-config

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'å¯ç”¨ Codespaces è°ƒè¯•ä¼šè¯'
        required: false
        default: false
  pull_request:
  push:
    branches: [ main, master ]
    paths:
      - '**.config'
      - '**.sh'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  CONFIG_FILE: X86_imm.config
  DIY_SH: diy-imm.sh
  FILE_NAME: X86
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup workdir
      run: |
        sudo mkdir -p /mnt/workdir
        sudo chown -R $USER:$USER /mnt/workdir
        echo "WORKDIR=/mnt/workdir" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          libncurses5-dev \
          libssl-dev \
          git \
          make

    - name: Clone source (with retry)
      working-directory: /mnt/workdir
      run: |
        for i in {1..3}; do
          git clone "$REPO_URL" -b "$REPO_BRANCH" openwrt && break || \
          { echo "::warning::Clone attempt $i/3 failed, retrying..."; sleep 5; }
          [ $i -eq 3 ] && { echo "::error::Failed to clone repository"; exit 1; }
        done

        cd openwrt
        echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date '+%Y-%m-%d_%H%M%S')" >> $GITHUB_ENV
        ln -sf /mnt/workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Apply configuration
      run: |
        cd /mnt/workdir/openwrt
        chmod +x "$GITHUB_WORKSPACE/$DIY_SH"
        "$GITHUB_WORKSPACE/$DIY_SH"
        cp "$GITHUB_WORKSPACE/$CONFIG_FILE" .config

    - name: å‡†å¤‡ Codespaces è°ƒè¯•ç¯å¢ƒ
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
      run: |
        echo "â³ è¯·æ‰‹åŠ¨åˆ›å»º Codespace è¿›è¡Œè°ƒè¯•ï¼š"
        echo "1. è®¿é—® https://github.com/codespaces"
        echo "2. é€‰æ‹©å½“å‰ä»“åº“ ($GITHUB_REPOSITORY)"
        echo "3. ç‚¹å‡» 'New codespace'"
        echo "4. å·¥ä½œç›®å½•å·²æŒ‚è½½åˆ° /workspaces/$GITHUB_REPOSITORY/openwrt"
        echo "ğŸ” è°ƒè¯•å®Œæˆåï¼Œè¯·åœ¨æ­¤é¡µé¢æŒ‰ Ctrl+C ç»ˆæ­¢å·¥ä½œæµ..."
        sleep 86400  # ä¿æŒ24å°æ—¶ç­‰å¾…ï¼ˆå®é™…å¯æ‰‹åŠ¨åœæ­¢ï¼‰

    - name: Package config
      run: |
        OUTPUT_NAME="${FILE_NAME}_${COMMIT_HASH}_${BUILD_DATE}.config"
        cp "/mnt/workdir/openwrt/.config" "$OUTPUT_NAME"
        echo "RELEASE_NAME=ImmortalWRT ${FILE_NAME} Config ${BUILD_DATE}" >> $GITHUB_ENV
        echo "CONFIG_PATH=$PWD/$OUTPUT_NAME" >> $GITHUB_ENV

    - name: Create release
      uses: softprops/action-gh-release@v1
      env:
        CONFIG_FILENAME: ${{ env.FILE_NAME }}_${{ env.COMMIT_HASH }}_${{ env.BUILD_DATE }}.config
      with:
        name: ImmortalWRT X86 Config
        tag_name: "imm-config"
        body: |
          ### é…ç½®æ–‡ä»¶è¯´æ˜
          ğŸ“ æœ€æ–°ç‰ˆæ–‡ä»¶åï¼š`${{ env.FILE_NAME }}_${{ env.COMMIT_HASH }}_${{ env.BUILD_DATE }}.config`
      
          ğŸ” ç‰ˆæœ¬ä¿¡æ¯ï¼š
          - æœ€æ–°ç‰ˆæäº¤å“ˆå¸Œï¼š`${{ env.COMMIT_HASH }}`
          - æœ€æ–°ç‰ˆç”Ÿæˆæ—¶é—´ï¼š`${{ env.BUILD_DATE }}`ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          - æ–‡ä»¶å‘½ååŒ…å«configæ–‡ä»¶ç”Ÿæˆæ—¶é—´ï¼Œå¯æŒ‰éœ€ä¸‹è½½
      
          âš™ï¸ ä½¿ç”¨æ–¹å¼ï¼š
          1. ä¸‹è½½åé‡å‘½åä¸º`.config`
          2. æ”¾ç½®åˆ°OpenWrtç¼–è¯‘ç›®å½•
          3. è¿è¡Œ`make defconfig`
        files: ${{ env.CONFIG_PATH }}
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
