name: ImmortalWRT Config Master

on:
  workflow_dispatch:
    inputs:
      interactive_debug:
        type: boolean
        description: 'å¯ç”¨æµè§ˆå™¨äº¤äº’è°ƒè¯•'
        required: false
        default: false

env:
  BUILD_DIR: /mnt/immortal_build
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master

jobs:
  config_production:
    runs-on: ubuntu-22.04
    timeout-minutes: 240

    steps:
    # ================ ç¯å¢ƒåˆå§‹åŒ– ================
    - name: Checkout Configurations
      uses: actions/checkout@v4

    - name: Setup ImmortalWRT Build Environment
      run: |
        sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
        sudo mkdir -p ${{ env.BUILD_DIR }}
        sudo chown -R $USER:$USER ${{ env.BUILD_DIR }}
        df -h

    # ================ æºç å‡†å¤‡ ================
    - name: Clone Source Code
      working-directory: ${{ env.BUILD_DIR }}
      run: |
        git clone --depth=1 --single-branch -b ${{ env.REPO_BRANCH }} \
          ${{ env.REPO_URL }} openwrt
        cd openwrt
        echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date '+%Y%m%d-%H%M%S')" >> $GITHUB_ENV

    # ================ é…ç½®åˆå§‹åŒ– ================
    - name: Apply Base Config
      working-directory: ${{ env.BUILD_DIR }}/openwrt
      run: |
        chmod +x "$GITHUB_WORKSPACE/diy-imm.sh"
        "$GITHUB_WORKSPACE/diy-imm.sh"

    # ================ äº¤äº’è°ƒè¯• ================
    - name: Browser-based Debug Terminal
      if: ${{ inputs.interactive_debug }}
      uses: devcontainers/ci@v0.3
      with:
        runCmd: |
          echo "ğŸ› ï¸ äº¤äº’è°ƒè¯•ç»ˆç«¯å·²æ¿€æ´»"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "ä¿®æ”¹é…ç½®åæ‰§è¡Œ:"
          echo "  make defconfig"
          echo "  exit"
          tail -f /dev/null  # ä¿æŒä¼šè¯æ´»è·ƒ

    # ================ æˆå“ç”Ÿæˆ ================
    - name: Generate Final Config
      working-directory: ${{ env.BUILD_DIR }}/openwrt
      run: |
        make defconfig
        FINAL_CONFIG="immortalwrt_${FILE_NAME}_${COMMIT_HASH}_${BUILD_DATE}.config"
        cp .config "$GITHUB_WORKSPACE/$FINAL_CONFIG"
        echo "CONFIG_PATH=$GITHUB_WORKSPACE/$FINAL_CONFIG" >> $GITHUB_ENV

    # ================ å‘å¸ƒç®¡ç† ================
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: immortal-config
        path: ${{ env.CONFIG_PATH }}

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: "ImmortalWRT_config"
        tag_name: "config-imm"
        body: |
          ### é…ç½®æ–‡ä»¶è¯´æ˜
          - æ–‡ä»¶å‘½ååŒ…å«configæ–‡ä»¶ç”Ÿæˆæ—¶é—´ï¼Œå¯æŒ‰éœ€ä¸‹è½½
          âš™ï¸ ä½¿ç”¨æ–¹å¼ï¼š
          1. ä¸‹è½½åé‡å‘½åä¸º`.config`
          2. æ”¾ç½®åˆ°OpenWrtç¼–è¯‘ç›®å½•
          3. è¿è¡Œ`make defconfig`
        files: ${{ env.CONFIG_PATH }}
        token: ${{ secrets.GITHUB_TOKEN }}
