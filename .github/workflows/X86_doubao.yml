name: Build OpenWrt_X86_Optimized

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: "0 23 5 * *"

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: X86.config
  DIY_SH: diy-X86.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  FILE_NAME: X86
  TZ: Asia/Shanghai
  MAX_JOBS: 4  # æ§åˆ¶ç¼–è¯‘å¹¶å‘æ•°

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id
    
    steps:
    - name: Checkout OpenWrt
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # æµ…å…‹éš†åŠ é€Ÿ

    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo -e "------ ç³»ç»Ÿä¿¡æ¯ ------"
        uname -a
        lsb_release -a 2>/dev/null || echo "æœªå®‰è£…lsb_release"
        echo -e "\n------ CPUä¿¡æ¯ ------"
        echo "æ ¸å¿ƒæ•°: $(nproc)"
        echo "å‹å·: $(grep -m1 "model name" /proc/cpuinfo | cut -d: -f2)"
        echo -e "\n------ å†…å­˜ä¿¡æ¯ ------"
        free -h
        echo -e "\n------ å­˜å‚¨ä¿¡æ¯ ------"
        df -Th

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # æ¸…ç†Dockerç¼“å­˜
        docker rmi -f $(docker images -q) 2>/dev/null || true
        
        # ä¿ç•™å¿…è¦ç³»ç»Ÿç»„ä»¶
        sudo apt-mark hold grub-efi-amd64-signed
        
        # æ›´æ–°ç³»ç»Ÿ
        sudo apt-get update -y
        sudo apt-get purge -y azure-cli* docker* ghc* zulu* llvm* firefox google* dotnet* powershell* openjdk* mysql* php* mongodb* snap*
        sudo apt-get full-upgrade -y
        
        # å®‰è£…ä¾èµ–
        sudo apt-get install -y \
          build-essential ccache clang cmake gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-pip zlib1g-dev \
          binutils bison flex autoconf automake libtool pkgconf libelf-dev \
          libfuse-dev libmpc-dev libmpfr-dev subversion ninja-build rsync \
          upx-ucl p7zip-full curl wget unzip vim
        
        # æ¸…ç†ç©ºé—´
        sudo apt-get autoremove --purge -y
        sudo apt-get clean
        sudo timedatectl set-timezone "$TZ"
        
        # åˆ›å»ºå·¥ä½œç›®å½•
        sudo mkdir -p /mnt/workdir
        sudo chown $USER:$(id -gn) /mnt/workdir
        df -Th

    - name: ä¸‹è½½å›ºä»¶æºç 
      working-directory: /mnt/workdir
      run: |
        echo "å·¥ä½œç›®å½•ç©ºé—´:"
        df -hT "$PWD"
        
        git clone --depth=1 --branch="$REPO_BRANCH" --single-branch "$REPO_URL" openwrt
        ln -sfn "/mnt/workdir/openwrt" "$GITHUB_WORKSPACE/openwrt"
        
        cd openwrt
        echo "æºç ç‰ˆæœ¬ä¿¡æ¯:" > version-info.txt
        git show -s --date=short --format="Author: %an%nDate: %cd%nCommit: %s%nHash: %H" >> version-info.txt
        cat version-info.txt
        echo "useVersionInfo=$(cat version-info.txt)" >> $GITHUB_ENV
        echo "DATE=$(date "+%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "DATE1=$(date "+%Y-%m-%d")" >> $GITHUB_ENV

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        # ç¡®ä¿åœ¨æ­£ç¡®ç›®å½•æ‰§è¡Œ
        cd "$GITHUB_WORKSPACE"
        
        echo "åº”ç”¨è‡ªå®šä¹‰è„šæœ¬..."
        if [ -f "$DIY_SH" ]; then
          chmod +x "$DIY_SH"
          (cd openwrt && source "../$DIY_SH")
        fi
        
        echo "ç§»åŠ¨é…ç½®æ–‡ä»¶..."
        if [ -d "files" ]; then
          mv -v "files" "openwrt/files"
        fi
        if [ -f "$CONFIG_FILE" ]; then
          mv -v "$CONFIG_FILE" "openwrt/.config"
        fi
        
        echo "æœ€ç»ˆæ£€æŸ¥:"
        ls -l openwrt/.config openwrt/files/ 2>/dev/null || echo "æ— è‡ªå®šä¹‰é…ç½®"

    - name: ä¸‹è½½ä¾èµ–åŒ…
      id: package
      working-directory: "$GITHUB_WORKSPACE/openwrt"
      run: |
        echo "ä½¿ç”¨$MAX_JOBSä¸ªå¹¶è¡Œä»»åŠ¡ä¸‹è½½..."
        make defconfig
        make download -j$MAX_JOBS
        
        # æ¸…ç†æ— æ•ˆä¸‹è½½
        find dl -size -1024c -delete
        echo "ä¸‹è½½å®Œæˆï¼Œå‰©ä½™ç©ºé—´:"
        df -h

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      working-directory: "$GITHUB_WORKSPACE/openwrt"
      run: |
        echo "å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨$MAX_JOBSä¸ªçº¿ç¨‹..."
        
        # åˆ†é˜¶æ®µç¼–è¯‘ç­–ç•¥
        make -j$MAX_JOBS || \
        make -j$((MAX_JOBS/2)) || \
        make -j1 V=s
        
        # è®°å½•è®¾å¤‡ä¿¡æ¯
        DEVICE=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')
        [ -n "$DEVICE" ] && echo "DEVICE_NAME=_$DEVICE" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        
        echo "ç¼–è¯‘å®Œæˆï¼è¾“å‡ºæ–‡ä»¶:"
        ls -lh bin/targets/*/*/

    - name: æ¸…ç†å·¥ä½œç©ºé—´
      if: steps.compile.outcome == 'success' && !cancelled()
      working-directory: "$GITHUB_WORKSPACE/openwrt"
      run: |
        shopt -s extglob
        rm -rf !(bin|logs|version-info.txt)
        echo "æ¸…ç†åç©ºé—´:"
        df -h

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && steps.compile.outcome == 'success' && !cancelled()
      run: |
        TARGET_DIR=$(find "$GITHUB_WORKSPACE/openwrt/bin/targets" -type d -path "*/targets/*/*" | head -1)
        [ -z "$TARGET_DIR" ] && { echo "é”™è¯¯ï¼šæ‰¾ä¸åˆ°å›ºä»¶ç›®å½•"; exit 1; }
        
        cd "$TARGET_DIR"
        echo "å›ºä»¶ç›®å½•: $PWD"
        ls -lh
        
        # å¤åˆ¶é…ç½®ä¿¡æ¯
        cp "$GITHUB_WORKSPACE/openwrt/version-info.txt" .
        cp "$GITHUB_WORKSPACE/openwrt/.config" "${FILE_NAME}_config_${DATE1}.config"
        
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: "OpenWrt_${FILE_NAME}_${DATE1}${DEVICE_NAME}"
        path: "${{ env.FIRMWARE }}"
        retention-days: 7
        compression-level: 0

    - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
      id: release
      uses: ncipollo/release-action@v1
      if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: "OpenWrt ${FILE_NAME} ${DATE1}"
        tag: "v${DATE1}"
        commit: master
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          OpenWrt ${FILE_NAME} å›ºä»¶ç¼–è¯‘ç»“æœ
          ${{ env.useVersionInfo }}
          åŒ…å«æ’ä»¶: aria2, diskman, docker, openclash, ssr-plusç­‰
          ç¼–è¯‘æ—¶é—´: ${{ env.DATE }}
        artifacts: "${{ env.FIRMWARE }}/*"
        artifactErrorsFailBuild: false

    - name: TGé€šçŸ¥
      if: success()
      run: |
        curl -sSf -X POST \
          "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="OpenWrt X86å›ºä»¶ç¼–è¯‘æˆåŠŸï¼%0A%0AğŸ“… æ—¥æœŸ: ${DATE}%0AğŸ’¾ å¤§å°: $(du -sh ${{ env.FIRMWARE }} | cut -f1)%0AğŸ”§ åŒ…å«æ’ä»¶: aria2, diskman, docker, openclash, ssr-plus"
